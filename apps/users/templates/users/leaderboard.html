{% extends 'base.html' %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">Leaderboard</h1>
            <p class="mt-2 text-sm text-gray-700">See who's at the top of their game. Keep playing to climb the ranks!</p>
        </div>
        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
             <select id="grade-filter" name="grade" class="block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-brand-purple sm:text-sm sm:leading-6">
                <option value="">All Grades</option>
             </select>
        </div>
    </div>
    <div class="mt-8 flow-root">
        <div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8">
            <div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead>
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-0">Rank</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Student</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Grade</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Level</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">XP</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body" class="divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-8 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem('accessToken');
    if (!token) { window.location.href = "{% url 'users:login' %}"; return; }

    const leaderboardBody = document.getElementById('leaderboard-body');
    const gradeFilter = document.getElementById('grade-filter');

    const fetchLeaderboard = async (gradeId = null) => {
        let url = '/api/v1/leaderboard/';
        if (gradeId) {
            url += `?grade_id=${gradeId}`;
        }
        
        try {
            const response = await fetch(url, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to fetch leaderboard');
            
            const users = await response.json();
            leaderboardBody.innerHTML = ''; 

            if (users.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No data to display.</td></tr>';
                return;
            }

            const rankClasses = {
                1: 'bg-yellow-100 font-bold',
                2: 'bg-gray-200',
                3: 'bg-yellow-50'
            };
            const rankIcons = { 1: 'ðŸ¥‡', 2: 'ðŸ¥ˆ', 3: 'ðŸ¥‰' };

            users.forEach((user, index) => {
                const rank = index + 1;
                const rowClass = rankClasses[rank] || '';
                const rankIcon = rankIcons[rank] || rank;
                
                const row = `
                    <tr class="${rowClass}">
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium sm:pl-0">${rankIcon}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-900">${user.full_name}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${user.grade_name || 'N/A'}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${user.level}</td>
                        <td class="whitespace-nowrap px-3 py-4 text-sm font-semibold text-brand-purple">${user.xp} XP</td>
                    </tr>
                `;
                leaderboardBody.innerHTML += row;
            });
        } catch (error) {
            leaderboardBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-600">Could not load leaderboard.</td></tr>';
        }
    };

    fetch('/api/v1/grades/', { headers: { 'Authorization': `Bearer ${token}` }})
        .then(res => res.json())
        .then(grades => {
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade.id;
                option.textContent = grade.display_name;
                gradeFilter.appendChild(option);
            });
        });
    
    gradeFilter.addEventListener('change', () => {
        leaderboardBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Loading...</td></tr>'; 
        fetchLeaderboard(gradeFilter.value);
    });

    fetchLeaderboard();
});
</script>
{% endblock %}